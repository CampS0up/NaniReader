<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NaniReader üìñ</title>
  <link rel="manifest" href="/static/manifest.json" />
  <meta name="theme-color" content="#ff4f4f" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f4f4f4;
      margin: 1rem;
      color: #222;
    }
    h1, h2 { margin: 0.5em 0; }
    input, button {
      padding: 0.5em;
      font-size: 1rem;
      margin: 0.25em 0;
    }
    button { cursor: pointer; }
    img { max-width: 100%; margin: 0.5em 0; border-radius: 4px; }
    .screen { display: none; }
    .visible { display: block; }
    .read {
      opacity: 0.7;
      background-color: #eee;
      border: 2px solid #999;
      text-decoration: none;
      font-weight: bold;
    }
    .chapter-button {
      display: block;
      margin: 0.2em 0;
      padding: 0.4em;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .chapter-button.read::after {
      content: " ‚úîÔ∏è";
      float: right;
    }
    .nav-btns {
      display: flex;
      justify-content: space-between;
      margin: 1em 0;
    }
    .back {
      margin-top: 1em;
      display: inline-block;
      cursor: pointer;
      color: #555;
      text-decoration: underline;
    }
    #progressBarContainer {
      margin: 1em 0 0.5em 0;
    }
    #progressBarWrapper {
      background: #ddd;
      border-radius: 5px;
      overflow: hidden;
    }
    #progressBar {
      height: 10px;
      width: 0%;
      transition: width 0.3s ease;
    }
    .progress-low    { background: #e74c3c; }
    .progress-mid    { background: #f39c12; }
    .progress-high   { background: #2ecc71; }
  </style>
</head>
<body>
  <h1>NaniReader üìö</h1>

  <div id="homeScreen" class="screen visible">
    <input id="searchInput" placeholder="Search manga..." />
    <button onclick="searchManga()">Search</button>
    <button onclick="showFavorites()">‚≠ê Favorites</button>
    <div id="results"></div>
  </div>

  <div id="mangaScreen" class="screen">
    <div class="back" onclick="goHome()">‚Üê Back to search</div>
    <h2 id="mangaTitle"></h2>
    <img id="coverImage" />
    <p id="mangaDescription"></p>

    <div id="progressBarContainer" style="display: none;">
      <div style="font-size: 0.9em;" id="progressText">Progress: 0%</div>
      <div id="progressBarWrapper">
        <div id="progressBar" class="progress-low"></div>
      </div>
    </div>

    <h3>Chapters</h3>
    <div id="chapters"></div>
  </div>

  <div id="readerScreen" class="screen">
    <div class="back" onclick="goToManga()">‚Üê Back to manga</div>
    <div class="nav-btns">
      <button onclick="prevChapter()">‚¨ÜÔ∏è Previous</button>
      <button onclick="nextChapter()">‚¨áÔ∏è Next</button>
    </div>
    <div id="pages"></div>
    <div class="nav-btns">
      <button onclick="prevChapter()">‚¨ÜÔ∏è Previous</button>
      <button onclick="nextChapter()">‚¨áÔ∏è Next</button>
    </div>
  </div>

  <script>
    const API = "/api";
    let currentMangaId = null;
    let currentChapters = [];
    let currentChapterIndex = 0;

    const switchScreen = id => {
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("visible"));
      document.getElementById(id).classList.add("visible");
    };
    const goHome = () => switchScreen("homeScreen");
    const goToManga = () => switchScreen("mangaScreen");

    function getReadChapters(mangaId) {
      return JSON.parse(localStorage.getItem("read_" + mangaId) || "[]");
    }

    function markChapterRead(mangaId, chapterId) {
      const key = "read_" + mangaId;
      const read = getReadChapters(mangaId);
      if (!read.includes(chapterId)) {
        read.push(chapterId);
        localStorage.setItem(key, JSON.stringify(read));
      }
    }

    function isFavorite(id) {
      const favs = JSON.parse(localStorage.getItem("favorites") || "[]");
      return favs.find(f => f.id === id);
    }

    function toggleFavorite(manga) {
      let favs = JSON.parse(localStorage.getItem("favorites") || "[]");
      if (favs.find(f => f.id === manga.id)) {
        favs = favs.filter(f => f.id !== manga.id);
      } else {
        favs.push(manga);
      }
      localStorage.setItem("favorites", JSON.stringify(favs));
      showFavorites();
    }

    async function searchManga() {
      const query = document.getElementById("searchInput").value;
      const res = await fetch(`${API}/search?title=${encodeURIComponent(query)}`);
      const mangas = await res.json();
      const div = document.getElementById("results");
      div.innerHTML = "<h3>Results</h3>";
      mangas.forEach(m => {
        const btn = document.createElement("button");
        btn.innerText = (isFavorite(m.id) ? "‚ù§Ô∏è " : "") + m.title;
        btn.onclick = () => openManga(m.id, m.title);
        div.appendChild(btn);
      });
    }

    function showFavorites() {
      const favs = JSON.parse(localStorage.getItem("favorites") || "[]");
      const div = document.getElementById("results");
      div.innerHTML = "<h3>Favorites</h3>";
      favs.forEach(m => {
        const btn = document.createElement("button");
        btn.innerText = "‚ù§Ô∏è " + m.title;
        btn.onclick = () => openManga(m.id, m.title);
        div.appendChild(btn);
      });
    }

    async function openManga(mangaId, title) {
      switchScreen("mangaScreen");
      currentMangaId = mangaId;
      document.getElementById("mangaTitle").innerText = title;

      const res = await fetch(`${API}/manga/${mangaId}`);
      const detail = await res.json();
      document.getElementById("mangaDescription").innerText = detail.description;
      document.getElementById("coverImage").src = detail.cover_url;

      const chapRes = await fetch(`${API}/chapters/${mangaId}`);
      currentChapters = await chapRes.json();
      const read = getReadChapters(mangaId);

      const div = document.getElementById("chapters");
      div.innerHTML = "";

      let readCount = 0;
      currentChapters.forEach((ch, idx) => {
        const btn = document.createElement("button");
        let label = ch.chapter ? `Chapter ${ch.chapter}` : `Chapter ID ${ch.id.slice(0, 6)}‚Ä¶`;
        if (ch.title) label += ` ‚Äî ${ch.title}`;
        btn.innerText = label;
        btn.className = "chapter-button";
        btn.dataset.id = ch.id;
        if (read.includes(ch.id)) {
          btn.classList.add("read");
          readCount++;
        }
        btn.onclick = () => openChapter(idx);
        div.appendChild(btn);
      });

      const percent = currentChapters.length > 0 ? Math.round((readCount / currentChapters.length) * 100) : 0;
      const bar = document.getElementById("progressBar");
      bar.style.width = percent + "%";
      bar.className = "";
      if (percent < 34) bar.classList.add("progress-low");
      else if (percent < 67) bar.classList.add("progress-mid");
      else bar.classList.add("progress-high");

      document.getElementById("progressText").innerText = `Progress: ${percent}% (${readCount} of ${currentChapters.length})`;
      document.getElementById("progressBarContainer").style.display = "block";
    }

    async function openChapter(index) {
      const chapter = currentChapters[index];
      currentChapterIndex = index;
      switchScreen("readerScreen");
      markChapterRead(currentMangaId, chapter.id);

      const res = await fetch(`${API}/pages/${chapter.id}`);
      const pages = await res.json();
      const div = document.getElementById("pages");
      div.innerHTML = "";
      pages.forEach(url => {
        const img = document.createElement("img");
        img.src = url;
        div.appendChild(img);
      });

      document.querySelectorAll(".chapter-button").forEach(btn => {
        if (btn.dataset.id === chapter.id) btn.classList.add("read");
      });

      // ‚úÖ Update progress bar after marking read
      const read = getReadChapters(currentMangaId);
      const readCount = read.length;
      const total = currentChapters.length;
      const percent = total > 0 ? Math.round((readCount / total) * 100) : 0;
      const bar = document.getElementById("progressBar");
      bar.style.width = percent + "%";
      bar.className = "";
      if (percent < 34) bar.classList.add("progress-low");
      else if (percent < 67) bar.classList.add("progress-mid");
      else bar.classList.add("progress-high");

      document.getElementById("progressText").innerText = `Progress: ${percent}% (${readCount} of ${total})`;
    }function nextChapter() {
      if (currentChapterIndex < currentChapters.length - 1) {
        openChapter(currentChapterIndex + 1);
      }
    }

    function prevChapter() {
      if (currentChapterIndex > 0) {
        openChapter(currentChapterIndex - 1);
      }
    }
  </script>
</body>
</html>